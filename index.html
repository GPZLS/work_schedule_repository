<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Work Schedule Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 40px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .main-content {
            padding: 40px;
        }
        
        .section {
            margin-bottom: 40px;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
            font-weight: 500;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn.secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .btn.success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .btn.warning {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        
        .btn.danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }
        
        .btn.small {
            padding: 8px 16px;
            font-size: 12px;
        }
        
        input[type="text"], input[type="number"], input[type="email"], input[type="date"], select {
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            min-width: 200px;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }
        
        th {
            background: linear-gradient(135deg, #f8f9ff 0%, #e8ecff 100%);
            font-weight: 600;
            color: #333;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
        }
        
        tr:hover {
            background-color: #f8f9ff;
        }
        
        .total {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1rem;
        }
        
        .output-section {
            background: #f8f9ff;
        }
        
        #output {
            background: white;
            border: 2px solid #e8ecff;
            border-radius: 10px;
            padding: 20px;
            min-height: 200px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            overflow-y: auto;
            max-height: 600px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .modal-header h3 {
            color: #333;
            font-size: 1.5rem;
        }
        
        .close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .close:hover {
            background-color: #ff6b6b;
            color: white;
        }
        
        .schedule-day {
            margin-bottom: 25px;
            padding: 20px;
            border: 2px solid #f0f0f0;
            border-radius: 15px;
            background: #fafafa;
        }
        
        .schedule-day h4 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1rem;
            text-transform: capitalize;
        }
        
        .time-slot {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }
        
        .time-slot select {
            min-width: 120px;
        }
        
        .time-slot .btn {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .add-slot-btn {
            width: 100%;
            margin-top: 10px;
            padding: 10px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: 2px dashed #4facfe;
            color: white;
            font-weight: 500;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online {
            background-color: #4caf50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.3);
        }
        
        .status-offline {
            background-color: #f44336;
        }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .loading::after {
            content: '';
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #667eea;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error {
            color: #f44336;
            background: #ffebee;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #f44336;
        }
        
        .success {
            color: #4caf50;
            background: #e8f5e8;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #4caf50;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .tab {
            background: none;
            border: none;
            padding: 15px 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            align-items: end;
        }
        
        .form-row > * {
            flex: 1;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .section {
                padding: 20px;
            }
            
            .controls {
                justify-content: center;
            }
            
            input, select {
                min-width: auto;
                width: 100%;
            }
            
            .modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 20px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üïê Team Work Schedule Manager</h1>
            <p>Manage schedules, availability, and time slots efficiently</p>
        </div>
        
        <div class="main-content">
            <div class="section">
                <h2>üìä Quick Actions</h2>
                <div class="controls">
                    <button class="btn" onclick="loadUsers()">
                        üë• Load All Users
                    </button>
                    <button class="btn" onclick="loadWeeklySummary()">
                        üìà Weekly Summary
                    </button>
                    <button class="btn secondary" onclick="checkHealth()">
                        <span class="status-indicator status-offline" id="statusIndicator"></span>
                        Server Status
                    </button>
                    <button class="btn" onclick="clearOutput()">
                        üóëÔ∏è Clear Display
                    </button>
                </div>
            </div>
            
            <div class="section">
                <h2>‚ûï Add New Team Member</h2>
                <div class="controls">
                    <input type="text" id="userName" placeholder="Enter name" 
                           onkeypress="if(event.key==='Enter') addUser()">
                    <input type="email" id="userEmail" placeholder="Enter email (optional)">
                    <select id="userRole">
                        <option value="Team Member">Team Member</option>
                        <option value="Manager">Manager</option>
                        <option value="Developer">Developer</option>
                        <option value="Designer">Designer</option>
                        <option value="Analyst">Analyst</option>
                    </select>
                    <button class="btn" onclick="addUser()">Add Member</button>
                </div>
            </div>
            
            <div class="section">
                <h2>üîß User Management</h2>
                <div class="controls">
                    <input type="number" id="userId" placeholder="User ID" min="1">
                    <button class="btn success" onclick="editUserSchedule()">üìÖ Edit Schedule</button>
                    <button class="btn warning" onclick="editAvailability()">‚è∞ Edit Availability</button>
                    <button class="btn" onclick="getUserHours()">üëÅÔ∏è View Details</button>
                    <button class="btn danger" onclick="deleteUser()">üóëÔ∏è Delete User</button>
                </div>
            </div>
            
            <div class="section output-section">
                <h2>üìã Data Display</h2>
                <div id="output">
                    Welcome to the Team Work Schedule Manager!<br><br>
                    üîπ Click "Load All Users" to see team members<br>
                    üîπ Click "Weekly Summary" to view schedules<br>
                    üîπ Use "Edit Schedule" to set work hours<br>
                    üîπ Use "Edit Availability" to set when people are available<br><br>
                    Ready to get started!
                </div>
            </div>
        </div>
    </div>

    <!-- Schedule Modal -->
    <div id="scheduleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="scheduleModalTitle">Edit Weekly Schedule</h3>
                <button class="close" onclick="closeModal('scheduleModal')">&times;</button>
            </div>
            <div id="scheduleForm"></div>
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn success" onclick="saveSchedule()">üíæ Save Schedule</button>
                <button class="btn" onclick="closeModal('scheduleModal')">‚ùå Cancel</button>
            </div>
        </div>
    </div>

    <!-- Availability Modal -->
    <div id="availabilityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="availabilityModalTitle">Edit Availability</h3>
                <button class="close" onclick="closeModal('availabilityModal')">&times;</button>
            </div>
            
            <div class="tabs">
                <button class="tab active" onclick="showTab('permanent')">Permanent Availability</button>
                <button class="tab" onclick="showTab('temporary')">Temporary Changes</button>
            </div>
            
            <div id="permanent" class="tab-content active">
                <p style="color: #666; margin-bottom: 20px;">Set the regular hours when this person is available to work.</p>
                <div id="permanentAvailabilityForm"></div>
            </div>
            
            <div id="temporary" class="tab-content">
                <p style="color: #666; margin-bottom: 20px;">Set temporary changes for specific dates (overrides permanent availability).</p>
                <div class="form-row" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label>Select Date:</label>
                        <input type="date" id="tempDate" onchange="loadTempAvailability()">
                    </div>
                    <button class="btn secondary" onclick="addTempAvailability()">Add Date Override</button>
                </div>
                <div id="temporaryAvailabilityForm"></div>
                <div id="existingTempAvailability"></div>
            </div>
            
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn success" onclick="saveAvailability()">üíæ Save Availability</button>
                <button class="btn" onclick="closeModal('availabilityModal')">‚ùå Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';
        let timeSlots = [];
        let currentUserId = null;
        
        // Check server status and load time slots on load
        window.addEventListener('load', () => {
            checkHealth();
            loadTimeSlots();
            loadWeeklySummary();
        });
        
        async function makeRequest(url, options = {}) {
            try {
                const response = await fetch(API_BASE + url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Request failed:', error);
                displayError(`Error: ${error.message}`);
                throw error;
            }
        }
        
        async function loadTimeSlots() {
            try {
                timeSlots = await makeRequest('/time-slots');
                console.log('Time slots loaded:', timeSlots.length);
            } catch (error) {
                console.error('Failed to load time slots:', error);
            }
        }
        
        function displayData(data, title = '') {
            const output = document.getElementById('output');
            
            if (Array.isArray(data)) {
                // Display users as a table
                let html = title ? `<strong>${title}</strong><br><br>` : '';
                html += '<div class="table-container"><table>';
                html += '<tr><th>ID</th><th>Name</th><th>Email</th><th>Role</th><th>Actions</th></tr>';
                data.forEach(user => {
                    html += `<tr>
                        <td>${user.id}</td>
                        <td>${user.name}</td>
                        <td>${user.email || 'N/A'}</td>
                        <td>${user.role || 'Team Member'}</td>
                        <td>
                            <button class="btn small success" onclick="editUserScheduleById(${user.id})">üìÖ Schedule</button>
                            <button class="btn small warning" onclick="editAvailabilityById(${user.id})">‚è∞ Availability</button>
                            <button class="btn small danger" onclick="deleteUserById(${user.id})">Delete</button>
                        </td>
                    </tr>`;
                });
                html += '</table></div>';
                output.innerHTML = html;
            } else if (data.users) {
                // Display weekly summary as a table
                let html = '<strong>üìä Weekly Schedule Summary</strong><br><br>';
                html += '<div class="table-container"><table>';
                html += '<tr><th>Name</th><th>Role</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th><th>Sun</th><th>Total</th></tr>';
                data.users.forEach(user => {
                    html += `<tr>
                        <td><strong>${user.userName}</strong></td>
                        <td>${user.userRole || 'N/A'}</td>
                        <td>${user.hours.monday}h</td>
                        <td>${user.hours.tuesday}h</td>
                        <td>${user.hours.wednesday}h</td>
                        <td>${user.hours.thursday}h</td>
                        <td>${user.hours.friday}h</td>
                        <td>${user.hours.saturday}h</td>
                        <td>${user.hours.sunday}h</td>
                        <td class="total">${user.totalHours}h</td>
                    </tr>`;
                });
                html += `<tr style="border-top: 2px solid #667eea; background: #f8f9ff;">
                    <td colspan="9"><strong>GRAND TOTAL</strong></td>
                    <td class="total">${data.grandTotal}h</td>
                </tr>`;
                html += '</table></div>';
                if (data.generatedAt) {
                    html += `<br><em>Generated: ${new Date(data.generatedAt).toLocaleString()}</em>`;
                }
                output.innerHTML = html;
            } else {
                const content = (title ? `<strong>${title}</strong><br><br>` : '') + 
                               JSON.stringify(data, null, 2);
                output.innerHTML = content.replace(/\n/g, '<br>').replace(/ /g, '&nbsp;');
            }
        }
        
        function displayError(message) {
            document.getElementById('output').innerHTML = `<div class="error">${message}</div>`;
        }
        
        function displaySuccess(message) {
            document.getElementById('output').innerHTML = `<div class="success">${message}</div>`;
        }
        
        function setLoading(button, loading = true) {
            if (loading) {
                button.classList.add('loading');
                button.disabled = true;
            } else {
                button.classList.remove('loading');
                button.disabled = false;
            }
        }
        
        // Modal functions
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content and mark tab as active
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }
        
        // Time slot helper functions
        function createTimeSlotSelects(startTime = '09:00', endTime = '17:00') {
            const startSelect = document.createElement('select');
            const endSelect = document.createElement('select');
            
            startSelect.innerHTML = '<option value="">Start Time</option>';
            endSelect.innerHTML = '<option value="">End Time</option>';
            
            timeSlots.forEach(slot => {
                startSelect.innerHTML += `<option value="${slot.value}" ${slot.value === startTime ? 'selected' : ''}>${slot.display}</option>`;
                endSelect.innerHTML += `<option value="${slot.value}" ${slot.value === endTime ? 'selected' : ''}>${slot.display}</option>`;
            });
            
            return { startSelect, endSelect };
        }
        
        function createScheduleDay(dayName, slots = []) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'schedule-day';
            dayDiv.innerHTML = `<h4>${dayName}</h4>`;
            
            const slotsContainer = document.createElement('div');
            dayDiv.appendChild(slotsContainer);
            
            // Add existing slots
            slots.forEach((slot, index) => {
                const slotDiv = createTimeSlotDiv(dayName, slot.start, slot.end, index);
                slotsContainer.appendChild(slotDiv);
            });
            
            // Add "Add Slot" button
            const addBtn = document.createElement('button');
            addBtn.className = 'btn add-slot-btn';
            addBtn.innerHTML = '‚ûï Add Time Slot';
            addBtn.onclick = () => {
                const newSlotDiv = createTimeSlotDiv(dayName, '', '', slotsContainer.children.length);
                slotsContainer.appendChild(newSlotDiv);
            };
            dayDiv.appendChild(addBtn);
            
            return dayDiv;
        }
        
        function createTimeSlotDiv(dayName, startTime, endTime, index) {
            const slotDiv = document.createElement('div');
            slotDiv.className = 'time-slot';
            
            const { startSelect, endSelect } = createTimeSlotSelects(startTime, endTime);
            startSelect.name = `${dayName}_start_${index}`;
            endSelect.name = `${dayName}_end_${index}`;
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'btn danger small';
            removeBtn.innerHTML = 'üóëÔ∏è';
            removeBtn.onclick = () => slotDiv.remove();
            
            slotDiv.appendChild(document.createTextNode('From: '));
            slotDiv.appendChild(startSelect);
            slotDiv.appendChild(document.createTextNode(' To: '));
            slotDiv.appendChild(endSelect);
            slotDiv.appendChild(removeBtn);
            
            return slotDiv;
        }
        
        // User management functions
        async function loadUsers() {
            const button = event?.target || document.querySelector('[onclick="loadUsers()"]');
            setLoading(button);
            
            try {
                const data = await makeRequest('/users');
                displayData(data, 'üë• All Team Members');
            } catch (error) {
                console.error('Failed to load users:', error);
            } finally {
                setLoading(button, false);
            }
        }
        
        async function loadWeeklySummary() {
            const button = event?.target || document.querySelector('[onclick="loadWeeklySummary()"]');
            if (button) setLoading(button);
            
            try {
                const data = await makeRequest('/weekly-summary');
                displayData(data);
            } catch (error) {
                console.error('Failed to load weekly summary:', error);
            } finally {
                if (button) setLoading(button, false);
            }
        }
        
        async function addUser() {
            const userName = document.getElementById('userName').value.trim();
            const userEmail = document.getElementById('userEmail').value.trim();
            const userRole = document.getElementById('userRole').value;
            const button = event?.target || document.querySelector('[onclick="addUser()"]');
            
            if (!userName) {
                displayError('Please enter a team member name');
                return;
            }
            
            setLoading(button);
            
            try {
                const data = await makeRequest('/users', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        name: userName,
                        email: userEmail,
                        role: userRole
                    })
                });
                
                document.getElementById('userName').value = '';
                document.getElementById('userEmail').value = '';
                document.getElementById('userRole').value = 'Team Member';
                displaySuccess(`‚úÖ Team member "${data.name}" added successfully! (ID: ${data.id})`);
                
                // Refresh the data
                setTimeout(loadWeeklySummary, 1000);
            } catch (error) {
                console.error('Failed to add user:', error);
            } finally {
                setLoading(button, false);
            }
        }
        
        async function deleteUser() {
            const userId = document.getElementById('userId').value;
            
            if (!userId) {
                displayError('Please enter a user ID');
                return;
            }
            
            await deleteUserById(userId);
        }
        
        async function deleteUserById(id) {
            if (!confirm(`Are you sure you want to delete this team member?`)) {
                return;
            }
            
            try {
                const data = await makeRequest(`/users/${id}`, {
                    method: 'DELETE'
                });
                
                document.getElementById('userId').value = '';
                displaySuccess(`‚úÖ ${data.message}`);
                setTimeout(loadWeeklySummary, 1000);
            } catch (error) {
                console.error('Failed to delete user:', error);
            }
        }
        
        async function getUserHours() {
            const userId = document.getElementById('userId').value;
            const button = event?.target || document.querySelector('[onclick="getUserHours()"]');
            
            if (!userId) {
                displayError('Please enter a user ID');
                return;
            }
            
            setLoading(button);
            
            try {
                const data = await makeRequest(`/users/${userId}/schedule`);
                displayData(data, `‚è∞ Schedule Details for ${data.userName}`);
            } catch (error) {
                console.error('Failed to get user hours:', error);
            } finally {
                setLoading(button, false);
            }
        }
        
        // Schedule editing functions
        async function editUserSchedule() {
            const userId = document.getElementById('userId').value;
            
            if (!userId) {
                displayError('Please enter a user ID');
                return;
            }
            
            await editUserScheduleById(userId);
        }
        
        async function editUserScheduleById(userId) {
            try {
                currentUserId = userId;
                const userData = await makeRequest(`/users/${userId}/schedule`);
                
                document.getElementById('scheduleModalTitle').textContent = `Edit Schedule - ${userData.userName}`;
                
                const scheduleForm = document.getElementById('scheduleForm');
                scheduleForm.innerHTML = '';
                
                const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                days.forEach(day => {
                    const daySchedule = userData.schedule[day] || [];
                    const dayDiv = createScheduleDay(day, daySchedule);
                    scheduleForm.appendChild(dayDiv);
                });
                
                showModal('scheduleModal');
            } catch (error) {
                console.error('Failed to load user schedule:', error);
            }
        }
        
        async function saveSchedule() {
            if (!currentUserId) return;
            
            const scheduleData = {};
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            
            days.forEach(day => {
                scheduleData[day] = [];
                const dayContainer = document.querySelector(`.schedule-day h4[textContent="${day}"]`)?.parentElement;
                if (!dayContainer) return;
                
                const timeSlots = dayContainer.querySelectorAll('.time-slot');
                timeSlots.forEach(slot => {
                    const startSelect = slot.querySelector(`select[name^="${day}_start"]`);
                    const endSelect = slot.querySelector(`select[name^="${day}_end"]`);
                    
                    if (startSelect && endSelect && startSelect.value && endSelect.value) {
                        if (startSelect.value < endSelect.value) {
                            scheduleData[day].push({
                                start: startSelect.value,
                                end: endSelect.value
                            });
                        }
                    }
                });
            });
            
            try {
                await makeRequest(`/users/${currentUserId}/schedule`, {
                    method: 'PUT',
                    body: JSON.stringify({ schedule: scheduleData })
                });
                
                displaySuccess('‚úÖ Schedule updated successfully!');
                closeModal('scheduleModal');
                setTimeout(loadWeeklySummary, 1000);
            } catch (error) {
                console.error('Failed to save schedule:', error);
            }
        }
        
        // Availability editing functions
        async function editAvailability() {
            const userId = document.getElementById('userId').value;
            
            if (!userId) {
                displayError('Please enter a user ID');
                return;
            }
            
            await editAvailabilityById(userId);
        }
        
        async function editAvailabilityById(userId) {
            try {
                currentUserId = userId;
                
                // Get user data
                const users = await makeRequest('/users');
                const user = users.find(u => u.id == userId);
                if (!user) throw new Error('User not found');
                
                document.getElementById('availabilityModalTitle').textContent = `Edit Availability - ${user.name}`;
                
                // Load permanent availability
                await loadPermanentAvailability();
                
                // Load temporary availability
                await loadExistingTempAvailability();
                
                showModal('availabilityModal');
            } catch (error) {
                console.error('Failed to load availability:', error);
            }
        }
        
        async function loadPermanentAvailability() {
            try {
                const data = await makeRequest(`/users/${currentUserId}/permanent-availability`);
                
                const form = document.getElementById('permanentAvailabilityForm');
                form.innerHTML = '';
                
                const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                days.forEach(day => {
                    const dayAvailability = data.permanentAvailability[day] || [];
                    const dayDiv = createScheduleDay(day, dayAvailability);
                    form.appendChild(dayDiv);
                });
            } catch (error) {
                console.error('Failed to load permanent availability:', error);
            }
        }
        
        async function loadExistingTempAvailability() {
            try {
                const data = await makeRequest(`/users/${currentUserId}/temporary-availability`);
                
                const container = document.getElementById('existingTempAvailability');
                container.innerHTML = '<h4>Existing Temporary Changes:</h4>';
                
                if (Object.keys(data.temporaryAvailability).length === 0) {
                    container.innerHTML += '<p style="color: #666; font-style: italic;">No temporary changes set.</p>';
                    return;
                }
                
                Object.entries(data.temporaryAvailability).forEach(([date, availability]) => {
                    const dateDiv = document.createElement('div');
                    dateDiv.className = 'schedule-day';
                    dateDiv.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h4>${new Date(date).toLocaleDateString()} Changes</h4>
                            <button class="btn danger small" onclick="removeTempAvailability('${date}')">Remove</button>
                        </div>
                    `;
                    
                    Object.entries(availability).forEach(([day, slots]) => {
                        if (slots.length > 0) {
                            dateDiv.innerHTML += `<p><strong>${day.charAt(0).toUpperCase() + day.slice(1)}:</strong> `;
                            slots.forEach((slot, index) => {
                                const startTime = timeSlots.find(t => t.value === slot.start)?.display || slot.start;
                                const endTime = timeSlots.find(t => t.value === slot.end)?.display || slot.end;
                                dateDiv.innerHTML += `${startTime} - ${endTime}`;
                                if (index < slots.length - 1) dateDiv.innerHTML += ', ';
                            });
                            dateDiv.innerHTML += '</p>';
                        } else {
                            dateDiv.innerHTML += `<p><strong>${day.charAt(0).toUpperCase() + day.slice(1)}:</strong> Not available</p>`;
                        }
                    });
                    
                    container.appendChild(dateDiv);
                });
            } catch (error) {
                console.error('Failed to load temporary availability:', error);
            }
        }
        
        async function addTempAvailability() {
            const date = document.getElementById('tempDate').value;
            if (!date) {
                alert('Please select a date first');
                return;
            }
            
            const dateObj = new Date(date);
            const dayOfWeek = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'][dateObj.getDay()];
            
            const form = document.getElementById('temporaryAvailabilityForm');
            form.innerHTML = `<h4>Set availability for ${dateObj.toLocaleDateString()} (${dayOfWeek.charAt(0).toUpperCase() + dayOfWeek.slice(1)})</h4>`;
            
            const dayDiv = createScheduleDay(dayOfWeek, []);
            form.appendChild(dayDiv);
            
            const saveBtn = document.createElement('button');
            saveBtn.className = 'btn success';
            saveBtn.innerHTML = 'üíæ Save This Date';
            saveBtn.onclick = () => saveTempAvailability(date, dayOfWeek);
            form.appendChild(saveBtn);
        }
        
        async function saveTempAvailability(date, dayOfWeek) {
            const dayContainer = document.querySelector(`#temporaryAvailabilityForm .schedule-day`);
            if (!dayContainer) return;
            
            const slots = [];
            const timeSlots = dayContainer.querySelectorAll('.time-slot');
            
            timeSlots.forEach(slot => {
                const startSelect = slot.querySelector('select[name^="' + dayOfWeek + '_start"]');
                const endSelect = slot.querySelector('select[name^="' + dayOfWeek + '_end"]');
                
                if (startSelect && endSelect && startSelect.value && endSelect.value) {
                    if (startSelect.value < endSelect.value) {
                        slots.push({
                            start: startSelect.value,
                            end: endSelect.value
                        });
                    }
                }
            });
            
            const availability = {};
            availability[dayOfWeek] = slots;
            
            try {
                await makeRequest(`/users/${currentUserId}/temporary-availability`, {
                    method: 'PUT',
                    body: JSON.stringify({ date, availability })
                });
                
                displaySuccess(`‚úÖ Temporary availability saved for ${date}!`);
                document.getElementById('temporaryAvailabilityForm').innerHTML = '';
                document.getElementById('tempDate').value = '';
                await loadExistingTempAvailability();
            } catch (error) {
                console.error('Failed to save temporary availability:', error);
            }
        }
        
        async function removeTempAvailability(date) {
            if (!confirm(`Remove temporary availability for ${date}?`)) return;
            
            try {
                await makeRequest(`/users/${currentUserId}/temporary-availability/${date}`, {
                    method: 'DELETE'
                });
                
                displaySuccess(`‚úÖ Temporary availability removed for ${date}!`);
                await loadExistingTempAvailability();
            } catch (error) {
                console.error('Failed to remove temporary availability:', error);
            }
        }
        
        async function saveAvailability() {
            if (!currentUserId) return;
            
            // Save permanent availability
            const permanentData = {};
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            
            days.forEach(day => {
                permanentData[day] = [];
                const dayContainer = document.querySelector(`#permanentAvailabilityForm .schedule-day h4[textContent="${day}"]`)?.parentElement;
                if (!dayContainer) return;
                
                const timeSlots = dayContainer.querySelectorAll('.time-slot');
                timeSlots.forEach(slot => {
                    const startSelect = slot.querySelector(`select[name^="${day}_start"]`);
                    const endSelect = slot.querySelector(`select[name^="${day}_end"]`);
                    
                    if (startSelect && endSelect && startSelect.value && endSelect.value) {
                        if (startSelect.value < endSelect.value) {
                            permanentData[day].push({
                                start: startSelect.value,
                                end: endSelect.value
                            });
                        }
                    }
                });
            });
            
            try {
                await makeRequest(`/users/${currentUserId}/permanent-availability`, {
                    method: 'PUT',
                    body: JSON.stringify({ availability: permanentData })
                });
                
                displaySuccess('‚úÖ Availability updated successfully!');
                closeModal('availabilityModal');
            } catch (error) {
                console.error('Failed to save availability:', error);
            }
        }
        
        async function checkHealth() {
            const button = event?.target || document.querySelector('[onclick="checkHealth()"]');
            const indicator = document.getElementById('statusIndicator');
            
            if (button) setLoading(button);
            
            try {
                const data = await makeRequest('/health');
                displayData(data, '‚ù§Ô∏è Server Health Check');
                
                if (indicator) {
                    indicator.classList.remove('status-offline');
                    indicator.classList.add('status-online');
                }
            } catch (error) {
                console.error('Failed to check health:', error);
                if (indicator) {
                    indicator.classList.remove('status-online');
                    indicator.classList.add('status-offline');
                }
            } finally {
                if (button) setLoading(button, false);
            }
        }
        
        function clearOutput() {
            document.getElementById('output').innerHTML = 'Output cleared. Click any button above to load data...';
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>